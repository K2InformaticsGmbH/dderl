<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" >
<head>
    <title>Dashboard tests</title>
    <script language="javascript" src="../scripts/jquery.min.js" type="text/javascript"></script>
    <script language="javascript" src="../scripts/jquery-ui.min.js" type="text/javascript"></script>
    <script language="javascript" src="../scripts/jquery.combobox.js" type="text/javascript"></script>
    <script language="javascript" src="../qunit/qunit-1.12.0.js" type="text/javascript"></script>
    <script language="javascript" src="../scripts/dderl.js" type="text/javascript"></script>
    <script language="javascript" src="../scripts/dderl.dashView.js" type="text/javascript"></script>
    <script language="javascript" src="../scripts/dderl.dashboard.js" type="text/javascript"></script>
    <link media="screen" href="../qunit/qunit-1.12.0.css" type="text/css" rel="stylesheet"/>
     <script>
       function compareViews(views_value, views_expected) {
           equal(views_value.length, views_expected.length);
           for(var i = 0; i < views_value.length; ++i) {
               equal(views_value[i].getId(), views_expected[i].getId());
               deepEqual(views_value[i].getPos(), views_expected[i].getPos());
               deepEqual(views_value[i].getSize(), views_expected[i].getSize());
               deepEqual(views_value[i].getLayout(), views_expected[i].getLayout());
           }
       }

       test("Create dashView", function() {
           // DashView (id, x, y, width, height);
           var dashView = new DDerl.DashView(1, 3, 4, 100, 300);
           equal(dashView.getId(), 1);
           deepEqual(dashView.getPos(), {x: 3, y: 4});
           deepEqual(dashView.getSize(), {width: 100, height: 300});
           deepEqual(dashView.getLayout(), {x: 3, y: 4, width: 100, height: 300});
       });

       test("Create dashboard", function() {
           var dashViews, dashboard;
           dashViews = new Array();
           for(var i = 0; i < 5; ++i) {
               dashViews.push(new DDerl.DashView(2 + i, 3 + i, -1 + i*2, i*10, i*10 + 100));
           }
           dashboard = new DDerl.Dashboard(5, "My dash", dashViews);
           equal(dashboard.getId(), 5);
           equal(dashboard.getName(), "My dash");
           compareViews(dashboard.getViews(), dashViews);
       });

       test("Modify original view array", function() {
           var dashViews, equalViews, dashboard;
           dashViews = new Array();
           for(var i = 0; i < 5; ++i) {
               dashViews.push(new DDerl.DashView(2 + i, 3 + i, -1 + i*2, i*10, i*10 + 100));
           }
           dashboard = new DDerl.Dashboard(5, "My dash", dashViews);
           dashViews[1000] = new DDerl.DashView(2 + i, 3 + i, -1 + i*2, i*10, i*10 + 100);
           equalViews = new Array();
           for(var i = 0; i < 5; ++i) {
               equalViews.push(new DDerl.DashView(2 + i, 3 + i, -1 + i*2, i*10, i*10 + 100));
           }
           compareViews(dashboard.getViews(), equalViews);
       });

       test("Dynamic add views", function() {
           var dashViews, dashboard;
           dashboard = new DDerl.Dashboard(5, "My dash", []);
           dashViews = new Array();
           for(var i = 0; i < 5; ++i) {
               dashboard.addView(new DDerl.DashView(12345 + i*1000, 3 + i, -1 + i*2, i*10, i*10 + 100));
               dashViews.push(new DDerl.DashView(12345 + i*1000, 3 + i, -1 + i*2, i*10, i*10 + 100));
           }
           compareViews(dashboard.getViews(), dashViews);
       });

       test("Remove views", function() {
           var dashViews, dashboard, viewToRemove;
           dashViews = new Array();
           for(var i = 0; i < 5; ++i) {
               dashViews.push(new DDerl.DashView(i + 2, 3 + i, -1 + i*2, i*10, i*10 + 100));
           }
           dashboard = new DDerl.Dashboard(5, "My dash", dashViews);
           dashboard.removeView(5); // Remove view uses the view id.
           dashViews.splice(3, 1);
           compareViews(dashboard.getViews(), dashViews);
       });
                              
       test("Update view", function() {
           var dashViews, dashboard, updatedView;
           dashViews = new Array();
           for(var i = 0; i < 5; ++i) {
               dashViews.push(new DDerl.DashView(i + 2, 3 + i, -1 + i*2, i*10, i*10 + 100));
           }
           dashboard = new DDerl.Dashboard(5, "My dash", dashViews);
           updatedView = new DDerl.DashView(4, 6, 6, 10, 10);
           dashViews.splice(2, 1, updatedView);
           dashboard.addView(updatedView);
           compareViews(dashboard.getViews(), dashViews);
       });

       test("Dashboard as object", function() {
           var dashView, dashboard;
           dashView = new DDerl.DashView(1, 3, 4, 100, 300);
           dashboard = new DDerl.Dashboard(5, "My dash", [dashView]);
           deepEqual(dashboard.getAsObject(),
                          {
                              id: 5,
                              name: "My dash",
                              views: [
                                  {
                                      id: 1,
                                      layout: {x: 3, y: 4, width: 100, height: 300}
                                  }]
                          });
           dashboard.removeView(1);
           deepEqual(dashboard.getAsObject(), {id: 5, name: "My dash", views: []});
       });

       test("Save dashboard", function() {
           var dashViews, dataObj, dashboard;
           // Mock for the jquery ajax calls
           $.ajax = function(options) {
               equal(options.url, "/app/save_dashboard");
               dataObj = JSON.parse(options.data);
               equal(dataObj.dashboard.id, -1);
               options.success({save_dashboard: 5}, "ok", {status: 200});
           };
           dashViews = new Array();
           for(var i = 0; i < 5; ++i) {
               dashViews.push(new DDerl.DashView(i + 2, 3 + i, -1 + i*2, i*10, i*10 + 100));
           }
           dashboard = new DDerl.Dashboard(-1, "My dash", dashViews);
           dashboard.save();
           equal(dashboard.getId(), 5);
       });

       test("Update dashboard", function() {
           var dashViews, dataObj, dashboard;
           // Mock for the jquery ajax calls
           $.ajax = function(options) {
               equal(options.url, "/app/save_dashboard");
               dataObj = JSON.parse(options.data);
               equal(dataObj.dashboard.id, 5);
               options.success({save_dashboard: 5}, "ok", {status: 200});
           };
           dashView = new DDerl.DashView(1, 3, 4, 100, 300);
           dashboard = new DDerl.Dashboard(5, "My dash", [dashView]);
           dashboard.save();
           equal(dashboard.getId(), 5);
       });

     </script>
</head>
<body>
  <div id="qunit"></div>
</body>
</html>
